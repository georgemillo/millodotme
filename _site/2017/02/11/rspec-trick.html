<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>One Quick Trick to Make RSpec Play More Nicely - Millo's Musings</title><link href="https://fonts.googleapis.com/css?family=Lato:900|Work+Sans" rel="stylesheet"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/syntax.css"><title>One Quick Trick to Make RSpec Play More Nicely - Millo’s Musings</title><meta property="og:title" content="One Quick Trick to Make RSpec Play More Nicely" /><meta name="description" content="When you run the rspec command without specifying a particular file or group of files that contains your specs, it assumes that your specs live in the spec directory. (You can override this default with the –default-path option, although I’m not sure why you’d want to.)" /><meta property="og:description" content="When you run the rspec command without specifying a particular file or group of files that contains your specs, it assumes that your specs live in the spec directory. (You can override this default with the –default-path option, although I’m not sure why you’d want to.)" /><link rel="canonical" href="http://localhost:4000/2017/02/11/rspec-trick.html" /><meta property="og:url" content="http://localhost:4000/2017/02/11/rspec-trick.html" /><meta property="og:site_name" content="Millo’s Musings" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-02-11T00:00:00-02:00" /><script type="application/ld+json"> {"@context": "http://schema.org", "@type": "BlogPosting", "headline": "One Quick Trick to Make RSpec Play More Nicely", "datePublished": "2017-02-11T00:00:00-02:00", "description": "When you run the rspec command without specifying a particular file or group of files that contains your specs, it assumes that your specs live in the spec directory. (You can override this default with the –default-path option, although I’m not sure why you’d want to.)", "url": "http://localhost:4000/2017/02/11/rspec-trick.html"}</script></head><body style="background-color: rgb(255, 255, 255)"><script src="/js/theme.min.js"></script><header> <a href="/"><div class="home"></div></a></header><h1 class="post-headline">One Quick Trick to Make RSpec Play More Nicely</h1><div class="meta"> <span><em>February 11, 2017 by George Millo</em></span></div><p>When you run the <code class="highlighter-rouge">rspec</code> command without specifying a particular file or group of files that contains your specs, it assumes that your specs live in the <code class="highlighter-rouge">spec</code> directory. (You can override this default with the <a href="https://www.relishapp.com/rspec/rspec-core/v/3-0/docs/configuration/setting-the-default-spec-path">–default-path</a> option, although I’m not sure why you’d want to.)</p><p>But that’s not quite the ful story - <code class="highlighter-rouge">rspec</code> doesn’t simply run <em>all files within <code class="highlighter-rouge">spec</code></em>, it runs <em>all files within <code class="highlighter-rouge">spec</code> whose names end in <code class="highlighter-rouge">_spec.rb</code></em>. If it doesn’t end in <code class="highlighter-rouge">_spec.rb</code>, RSpec will assume that it doesn’t contain any specs - which is a good thing, because your <code class="highlighter-rouge">spec</code> directory probably contains various things <em>other</em> that specs (such as shared examples, factory definitions, or custom RSpec matchers), and if RSpec tries to “run” them as if they were specs, things will break.</p><p>That’s all fine, but the problem is that eventually - we’ve all done it - you’re going to create a spec file within <code class="highlighter-rouge">spec</code> and forgot to put <code class="highlighter-rouge">_spec</code> on the end of the name. You might be creating a model called <code class="highlighter-rouge">Doohickey</code>, and you put it in <code class="highlighter-rouge">app/models/doohickey.rb</code>. Then you go to create some specs for your new model and you have a brain fart and forget the “_spec”, putting your specs in <code class="highlighter-rouge">spec/models/doohickey.rb</code>. You might not even notice your mistake, because when you run the file individually with <code class="highlighter-rouge">rspec spec/models/doohickey.rb</code>, it’ll run fine.</p><p>The problem is that now when you run your entire suite with <code class="highlighter-rouge">rspec</code>, you’re going to run every test <em>except the ones in <code class="highlighter-rouge">spec/models/doohickey.rb</code></em>. Meaning that those tests could start failing and you won’t even notice, because you don’t realise that you’re not actually running them.</p><p>Well, after making the above mistake one too many times I resolved to not get fooled again, so I stuck the following code at the top of my <code class="highlighter-rouge">spec_helper.rb</code>:</p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">bad_file_names</span> <span class="o">=</span> <span class="n">spec_files</span><span class="p">.</span><span class="nf">reject</span> <span class="k">do</span> <span class="o">|</span><span class="n">path</span><span class="o">|</span>
  <span class="n">path</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'spec'</span><span class="p">,</span> <span class="s1">'support'</span><span class="p">))</span> <span class="o">||</span>
  <span class="n">path</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'spec'</span><span class="p">,</span> <span class="s1">'factories'</span><span class="p">))</span> <span class="o">||</span>
  <span class="n">path</span> <span class="o">=~</span> <span class="sr">/_spec.rb\z/</span> <span class="o">||</span> <span class="n">path</span> <span class="o">=~</span> <span class="sr">/_helper.rb\z/</span>
<span class="k">end</span>

<span class="k">if</span> <span class="n">bad_file_names</span><span class="p">.</span><span class="nf">any?</span>
  <span class="k">raise</span> <span class="s2">"Bad spec file names: </span><span class="si">#{</span><span class="n">bad_file_names</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span></code></pre></figure><p>In other words, before my tests run, I perform a quick check that there are no files in <code class="highlighter-rouge">spec</code> (excluding <code class="highlighter-rouge">spec/support</code> and <code class="highlighter-rouge">spec/factories</code>; you’ll need to tweak this depending on your own setup) that have names ending in something other than <code class="highlighter-rouge">_spec.rb</code> or <code class="highlighter-rouge">_helper.rb</code>, the last one being necessary so that <code class="highlighter-rouge">spec_helper.rb</code> and <code class="highlighter-rouge">rails_helper.rb</code> don’t trigger the alarm. If this isn’t the case, that means I’ve accidentally created a spec file with an incorrect name, so my <code class="highlighter-rouge">spec_helper</code> refuses to continue until I’ve fixed the error.</p><p>This minor addition to <code class="highlighter-rouge">spec_helper</code> lessens the chance of letting bugs and failing tests slip through the net, averting a potentially serious flaw with your test suite.</p><hr><p><em>Want to make an improvement or correction to this article? <a href='https://github.com/georgemillo/millodotme/tree/master/_posts'>Submit a PR on Github</a></em></p><footer><div class="links"> <a href="/about/">About</a> <a href="/testimonials/">Testimonials</a></div><div class="theme" onclick="theme()" style=" background-image: url(/images/theme.svg)"></div></footer><script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', '', 'auto'); ga('send', 'pageview');</script></body></html>
