<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Make Capybara Raise, Not Warn, When It Detects Unused Parameters - Millo's Musings</title><link href="https://fonts.googleapis.com/css?family=Lato:900|Work+Sans" rel="stylesheet"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/syntax.css"><title>Make Capybara Raise, Not Warn, When It Detects Unused Parameters - Millo’s Musings</title><meta property="og:title" content="Make Capybara Raise, Not Warn, When It Detects Unused Parameters" /><meta name="description" content="I love Capybara but there’s one little snag that keeps tripping me up. Have a look at the following RSpec code and see if you can spot the problem:" /><meta property="og:description" content="I love Capybara but there’s one little snag that keeps tripping me up. Have a look at the following RSpec code and see if you can spot the problem:" /><link rel="canonical" href="/capybara-unused-parameters" /><meta property="og:url" content="/capybara-unused-parameters" /><meta property="og:site_name" content="Millo’s Musings" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-04-04T00:00:00-03:00" /><script type="application/ld+json"> {"@context": "http://schema.org", "@type": "BlogPosting", "headline": "Make Capybara Raise, Not Warn, When It Detects Unused Parameters", "datePublished": "2017-04-04T00:00:00-03:00", "description": "I love Capybara but there’s one little snag that keeps tripping me up. Have a look at the following RSpec code and see if you can spot the problem:", "url": "/capybara-unused-parameters"}</script></head><body style="background-color: rgb(255, 255, 255)"><script src="/js/theme.min.js"></script><header> <a href="/"><div class="home"></div></a></header><h1 class="post-headline">Make Capybara Raise, Not Warn, When It Detects Unused Parameters</h1><div class="meta"> <span><em>April 04, 2017 by George Millo</em></span></div><p>I love Capybara but there’s one little snag that keeps tripping me up. Have a look at the following RSpec code and see if you can spot the problem:</p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">example</span> <span class="s1">'show user page'</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>

  <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span> <span class="n">user</span><span class="p">.</span><span class="nf">name</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span> <span class="n">user</span><span class="p">.</span><span class="nf">email_address</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_link</span> <span class="s1">'Edit'</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure><p>Did you see it? I’m using the <code class="highlighter-rouge">have_link</code> matcher incorrectly. The second argument is supposed to be a Hash, meaning the correct line looks like this:</p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_link</span> <span class="s1">'Edit'</span><span class="p">,</span> <span class="ss">href: </span><span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span></code></pre></figure><p>(Note that extra <code class="highlighter-rouge">href:</code>.)</p><p>It’s an easy mistake to make, especially when you consider the similarity with Rails’s <code class="highlighter-rouge">link_to</code> helper, which <em>does</em> take a String (not a Hash) as its second argument. I <em>still</em> occasionally mess up <code class="highlighter-rouge">have_link</code> in this way, and I’ve been working with Capybara and RSpec for four years.</p><p>The sneaky thing here is that if you forget the <code class="highlighter-rouge">href:</code>, the matcher won’t fail. It’ll just ignore whatever URL you passed in, and only test that the link has the correct text, not that it has the correct <code class="highlighter-rouge">href</code> attribute. Meaning that if you got the <code class="highlighter-rouge">href</code> attribute wrong, you now have a false positive.</p><p><a href="https://github.com/teamcapybara/capybara/blob/2.7.1/lib/capybara/queries/selector_query.rb#L22">Capybara does print a warning</a> when you make this mistake, but it’s easily missed, especially when the dodgy test is running alongside 1500 other tests in your suite. But since Capybara realises that something’s amiss, why can’t it just make the test fail? If I’ve passed a String as the second argument to <code class="highlighter-rouge">have_link</code>, that’s a mistake and I want to know about it immediately, so I can fix it immediately.</p><p>To that end, here’s a tiny little monkey-patch that will make the problem harder to miss (tested on Capybara 2.7.1). Stick this in <code class="highlighter-rouge">spec/support/raise_on_capybara_unused_parameters.rb</code>, and make sure the file is <code class="highlighter-rouge">require</code>d somewhere in your <code class="highlighter-rouge">rails_helper</code> or <code class="highlighter-rouge">spec_helper</code>:</p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Capybara</span>
  <span class="k">module</span> <span class="nn">Queries</span>
    <span class="k">class</span> <span class="nc">SelectorQuery</span>
      <span class="k">def</span> <span class="nf">warn</span><span class="p">(</span><span class="o">*</span><span class="n">messages</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">messages</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">start_with?</span><span class="p">(</span><span class="s1">'Unused parameters'</span><span class="p">)</span>
          <span class="k">raise</span> <span class="n">messages</span><span class="p">.</span><span class="nf">first</span>
        <span class="k">else</span>
          <span class="k">super</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure><p>Now, the next time you mess up <code class="highlighter-rouge">have_link</code>, you’ll realise straight away, because Capybara will raise an error and the test will fail. Fixing it is as easy as adding an <code class="highlighter-rouge">href:</code>, and now false positive test results are less likely to sneak through the net.</p><hr><p><em>Want to make an improvement or correction to this article? <a href='https://github.com/georgemillo/millodotme/tree/master/_posts'>Submit a PR on Github</a></em></p><footer><div class="links"> <a href="/about/">About</a> <a href="/testimonials/">Testimonials</a></div><div class="theme" onclick="theme()" style=" background-image: url(/images/theme.svg)"></div></footer><script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', '', 'auto'); ga('send', 'pageview');</script></body></html>
